# Organizational Data Core Package

This package provides the core functionality for accessing and querying organizational data in a performant, indexed manner.

## Overview

The `orgdatacore` package is designed to be a reusable component that can be consumed by multiple services including:
- Slack bots (ci-chat-bot)
- REST APIs
- CLI tools
- Other organizational data consumers

## Features

- **Fast Data Access**: Pre-computed indexes enable O(1) lookups for common queries
- **Thread-Safe**: Concurrent access with read-write mutex protection
- **Hot Reload**: Support for dynamic data updates without service restart
- **Pluggable Data Sources**: Load from files, GCS, or implement custom sources
- **Comprehensive Queries**: Employee, team, and organization lookups with membership validation
- **Cross-Cluster Ready**: Designed for distributed deployments with remote data sources

## Usage

### Basic Setup with Files

```go
package main

import (
    "github.com/openshift/ci-chat-bot/pkg/orgdata-core"
)

func main() {
    // Create a new service
    service := orgdatacore.NewService()
    
    // Load data from JSON files
    err := service.LoadFromFiles([]string{"comprehensive_index_dump.json"})
    if err != nil {
        log.Fatal(err)
    }
}
```

### Using DataSource Interface

```go
package main

import (
    "context"
    "github.com/openshift/ci-chat-bot/pkg/orgdata-core"
)

func main() {
    service := orgdatacore.NewService()
    
    // Load from files using DataSource interface
    fileSource := orgdatacore.NewFileDataSource("comprehensive_index_dump.json")
    err := service.LoadFromDataSource(context.Background(), fileSource)
    if err != nil {
        log.Fatal(err)
    }
    
    // Start watching for file changes
    service.StartDataSourceWatcher(context.Background(), fileSource)
}
```

### Google Cloud Storage Support

For GCS support, first add the GCS SDK dependency and build with the gcs tag:

```bash
go get cloud.google.com/go/storage
go build -tags gcs
```

```go
package main

import (
    "context"
    "time"
    "github.com/openshift/ci-chat-bot/pkg/orgdata-core"
)

func main() {
    service := orgdatacore.NewService()
    
    // Configure GCS
    config := orgdatacore.GCSConfig{
        Bucket:        "orgdata-sensitive",
        ObjectPath:    "orgdata/comprehensive_index_dump.json",
        ProjectID:     "your-project-id",
        CheckInterval: 5 * time.Minute,
        // Optional: provide service account credentials directly
        // CredentialsJSON: `{"type":"service_account",...}`,
    }
    
    // Load from GCS using the SDK implementation
    gcsSource, err := orgdatacore.NewGCSDataSourceWithSDK(context.Background(), config)
    if err != nil {
        log.Fatal(err)
    }
    
    err = service.LoadFromDataSource(context.Background(), gcsSource)
    if err != nil {
        log.Fatal(err)
    }
    
    // Start watching for GCS changes
    service.StartDataSourceWatcher(context.Background(), gcsSource)
}
```

## Data Structure

The package expects data in the `comprehensive_index_dump.json` format generated by the Python `orglib` indexing system.

## Interface

The package implements the `ServiceInterface` which provides comprehensive organizational data access methods.

## Thread Safety

All public methods are thread-safe and can be called concurrently from multiple goroutines.

## Data Sources

The package supports pluggable data sources through the `DataSource` interface:

### Built-in Data Sources

1. **FileDataSource** - Local JSON files
   - No additional dependencies
   - Supports file watching with polling
   - Ideal for development and file-based deployments

2. **GCSDataSource** - Google Cloud Storage
   - Requires GCS SDK: `go get cloud.google.com/go/storage`
   - Build with `-tags gcs` for full functionality
   - Supports hot reload with configurable polling interval
   - Uses Application Default Credentials (ADC) or service account JSON
   - Ideal for production cross-cluster deployments in GCP

### Custom Data Sources

Implement the `DataSource` interface to create custom sources:

```go
type DataSource interface {
    Load(ctx context.Context) (io.ReadCloser, error)
    Watch(ctx context.Context, callback func() error) error
    String() string
}
```

Examples of custom sources you could implement:
- HTTP/HTTPS endpoints  
- AWS S3 or other S3-compatible storage
- Git repositories
- Database queries
- Redis/Memcached for caching layers

## Dependencies

- Go 1.19+
- Standard library only (no external dependencies for file sources)
- Optional: GCS SDK for Google Cloud Storage support (`cloud.google.com/go/storage`)

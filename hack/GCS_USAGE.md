# Using ci-chat-bot with Google Cloud Storage (GCS) Backend

This document explains how to use ci-chat-bot with organizational data stored in Google Cloud Storage instead of local files.

## Overview

The GCS backend allows ci-chat-bot to load organizational data from a secure Google Cloud Storage bucket. This enables:
- **Centralized data**: Single source of truth for organizational data
- **Hot reload**: Automatic updates when data changes in GCS
- **Cross-cluster deployment**: Multiple ci-chat-bot (i.e. alpha instances) instances can share the same data
- **Security**: Bucket-level access control and encryption

## Prerequisites

1. **Google Cloud Project** with Storage API enabled
2. **GCS Bucket** containing organizational data
3. **Authentication** via Application Default Credentials or service account

## Quick Start

### Option 1: Using hack/run-with-gcs.sh (Recommended)

```bash
# Set required Slack credentials
export BOT_TOKEN="your-bot-token"
export BOT_SIGNING_SECRET="your-signing-secret"

# Run with GCS backend
./hack/run-with-gcs.sh
```

### Option 2: Using hack/run.sh with Environment Variables

```bash
# Enable GCS backend
export USE_GCS_ORGDATA=true

# Configure GCS (optional - these are the defaults)
export GCS_BUCKET="resolved-org"
export GCS_OBJECT_PATH="orgdata/comprehensive_index_dump.json"
export GCS_PROJECT_ID="openshift-crt-mce"
export GCS_CHECK_INTERVAL="5m"

# Run ci-chat-bot
./hack/run.sh
```

### Option 3: Manual Build and Run

```bash
# Build with GCS support
make BUILD_FLAGS="-tags gcs"

# Run with GCS flags
./ci-chat-bot \
  --gcs-enabled=true \
  --gcs-bucket=resolved-org \
  --gcs-project-id=openshift-crt-mce \
  --gcs-check-interval=5m \
  [other flags...]
```

## Configuration Options

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `USE_GCS_ORGDATA` | `false` | Enable GCS backend in hack/run.sh |
| `GCS_BUCKET` | `resolved-org` | GCS bucket name |
| `GCS_OBJECT_PATH` | `orgdata/comprehensive_index_dump.json` | Path to data file in bucket |
| `GCS_PROJECT_ID` | `openshift-crt-mce` | Google Cloud project ID |
| `GCS_CHECK_INTERVAL` | `5m` | How often to check for updates |
| `GCS_CREDENTIALS_JSON` | _(empty)_ | Service account JSON (optional) |

### Command Line Flags

| Flag | Description |
|------|-------------|
| `--gcs-enabled` | Enable GCS backend |
| `--gcs-bucket` | GCS bucket name |
| `--gcs-object-path` | Path to JSON file in bucket |
| `--gcs-project-id` | Google Cloud project ID |
| `--gcs-check-interval` | Update check frequency |
| `--gcs-credentials-json` | Service account credentials |

## Authentication

### Using Application Default Credentials (Recommended)

```bash
# Authenticate with gcloud
gcloud auth login
gcloud config set project openshift-crt-mce
```

### Using Service Account

```bash
# Set credentials via environment variable
export GCS_CREDENTIALS_JSON='{"type":"service_account",...}'

# OR via file
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account.json"
```

## Data Format

The GCS object should contain a `comprehensive_index_dump.json` file generated by the Python orglib indexing system. This file contains:

- Employee lookup tables (UID, Slack ID mappings)
- Team and organization hierarchies
- Pre-computed membership indexes
- Jira component ownership mappings

## Security

The GCS bucket should be configured with:
- ✅ **Public access prevention**: Enforced
- ✅ **Uniform bucket-level access**: Enabled
- ✅ **IAM-based access control**: Project members only
- ✅ **Bucket-level encryption**: Enabled

## Troubleshooting

### Build Issues
```bash
# Ensure GCS dependencies are available
go mod tidy

# Build with verbose output
make BUILD_FLAGS="-tags gcs -v"
```

### Runtime Issues
```bash
# Check GCS access
gcloud storage ls gs://resolved-org/orgdata/

# Test authentication
gcloud auth application-default print-access-token

# View detailed logs
./ci-chat-bot --gcs-enabled=true --v=4 [other flags...]
```

### Common Errors

1. **"GCS support not enabled"**: Build without `-tags gcs`
   - Solution: Use `make BUILD_FLAGS="-tags gcs"`

2. **"Access denied"**: Authentication or permissions issue
   - Solution: Check `gcloud auth list` and bucket IAM

3. **"Object not found"**: Incorrect bucket/path configuration
   - Solution: Verify `gcs-bucket` and `gcs-object-path` flags

## Migration from File-based

To migrate from local files to GCS:

1. **Upload your existing data**:
   ```bash
   gcloud storage cp comprehensive_index_dump.json gs://resolved-org/orgdata/
   ```

2. **Update your deployment**:
   - Change `USE_GCS_ORGDATA=false` to `USE_GCS_ORGDATA=true`
   - Remove `--orgdata-paths` flags
   - Add GCS configuration

3. **Test the setup**:
   ```bash
   ./hack/run-with-gcs.sh
   ```
